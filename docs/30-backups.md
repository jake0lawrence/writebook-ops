# 10 • Architecture

## 1 Droplet layout (single-VM, containerised)

| Layer | Component | What it does | Notes |
|-------|-----------|--------------|-------|
| **OS** | Ubuntu 22.04 (DigitalOcean droplet, 1–2 GB RAM) | Base image provisioned with cloud-init. | Keep hostname generic (`books`) to avoid `/etc/hosts → 127.0.1.1` confusion. |
| **Runtime** | Docker + Docker Compose | Isolates application services and pins exact versions. | Installed automatically by the ONCE one-liner. |
| **Reverse proxy** | **Traefik** container | Terminates TLS (Let’s Encrypt), routes HTTP → Writebook app. | Certificates auto-renew; config generated by the installer. |
| **App** | **Writebook** (Rails 7) container | Serves pages, admin UI, ActionText Markdown rendering. | Built from your forked repo in CI. |
| **Data** | `db.sqlite3` + `storage/` volume | SQLite DB + Active Storage uploads. | Mounted to host path (`/opt/writebook/data`) so backups don’t require Docker access. |
| **Control plane** | `once` CLI + systemd timer | Handles optional nightly auto-update & admin commands. | We disable the auto-update (see § 3). |

<small>ASCII diagram (side-view)</small>

```

┌──────── droplet (books.jakelawrence.io) ───────┐
│                                                │
│  \[traefik] ← 443/80 → internet                 │
│        ↓                                        │
│  \[writebook app] (rails)                        │
│        ↓  bind-mount                            │
│  /opt/writebook/data → { db.sqlite3, storage }  │
│                                                │
│  once.service  (CLI + nightly timer)            │
└─────────────────────────────────────────────────┘

````

---

## 2 “Fork + disable auto-update” workflow

Writebook ships with a built-in updater that **pulls and applies upstream changes every night at 02:00**.  
Community experience shows this can overwrite custom CSS, analytics snippets, or even break running
containers without warning. Recommended pattern:

1. **Fork** the Writebook source into a private GitHub repo (`gh:jake/writebook-fork`).  
2. **Disable** the on-droplet updater:  
   ```
   once auto-update off
   sudo systemctl disable once-auto-update.timer
   ```
3. **Weekly GitHub Action** pulls upstream `37signals/writebook`, rebases your fork, and opens a PR for review.
4. When merged, CI builds a new Docker image, tags it (`ghcr.io/jake/writebook:YYYY-MM-DD`), and
   deploys via SSH (`docker compose pull && docker compose up -d`).

Benefits:

* **Safety:** Updates run only after your custom patches (themes, GA snippet) are re-applied.
* **Audit trail:** Every upstream change is visible in a PR diff before it hits production.
* **Rollback:** Revert to a previous tag instantly if something breaks.

> “The default auto-update can overwrite changes or introduce surprises … fork and control your Writebook installation.”&#x20;

---

## 3 Why backups + CI live **outside** the ONCE container

| Concern                    | Inside-container approach                                         | External (our pattern)                                                                              |
| -------------------------- | ----------------------------------------------------------------- | --------------------------------------------------------------------------------------------------- |
| **Data integrity**         | `docker cp` of open SQLite file risks corruption.                 | `once data backup` stops the app momentarily, creates a safe tarball, then resumes.                 |
| **Recoverability**         | Restoring requires the exact container runtime.                   | Backups are plain `.tgz`; you can restore locally, on another host, or even inspect with `sqlite3`. |
| **Portability**            | Container-bound scripts can’t push to S3 without embedding creds. | Stand-alone Bash/Python scripts run via cron or GitHub Actions and use IAM-scoped keys.             |
| **Separation of concerns** | App image must include backup tooling, bloating size.             | App image stays lean; ops scripts evolve independently.                                             |

Community best practice emphasises **off-container backups**: a daily GitHub Actions cron job or droplet
cron copies the SQLite DB + uploads folder to S3/Spaces. This protects against accidental data loss and
lets you verify restores regularly.&#x20;

---

## 4 Key directories & volumes

| Path on droplet                  | Purpose                                  | Backup?                            |
| -------------------------------- | ---------------------------------------- | ---------------------------------- |
| `/opt/writebook/data/db.sqlite3` | Main content database.                   | **Yes** – nightly.                 |
| `/opt/writebook/data/storage/`   | Uploads & images.                        | **Yes** – nightly.                 |
| `/opt/writebook/config/`         | Traefik & Compose files (rarely change). | Optional (commit to repo instead). |
| `/var/backups/`                  | Cron-generated `.tgz` archives.          | Off-site sync to S3.               |

---

## 5 Next actions

1. Run `once auto-update off` and commit to managing updates via CI.
2. Ensure `/opt/writebook/data` is bind-mounted (default installer already does this).
3. Implement the backup cron or GitHub Action as detailed in **30-backups.md**.
4. Verify you can restore a `.tgz` into a fresh droplet before going live.

This architecture keeps your Writebook instance **predictable, reproducible, and resilient**—the foundation
for all the higher-level automations that follow.
